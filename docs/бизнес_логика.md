# Архитектура и Логика Приложения "АвтомойкаПро"

Этот документ описывает бизнес-логику, структуру данных и ключевые формулы, используемые в приложении для управления автомойкой.

## 1. Ключевые Сущности и Их Взаимосвязи

Функционал приложения строится вокруг нескольких основных сущностей:

- **Сотрудник (`Employee`)**: Работник автомойки. У каждого сотрудника есть уникальная **Схема зарплаты**.
- **Мойка (`WashEvent`)**: Центральная транзакционная сущность. Фиксирует дату, номер машины, исполнителей, услуги, способ оплаты, **расход химии** и **внутренние комментарии**.
- **Контрагент (`CounterAgent`)**: Корпоративный клиент со своим автопарком, индивидуальным прайс-листом и **балансом**.
- **Агрегатор (`Aggregator`)**: Компания-партнер (например, "Дорожная Сеть"), которая направляет клиентов. Имеет свои прайс-листы и **баланс**.
- **Схема зарплаты (`SalaryScheme`)**: Правило, по которому рассчитывается вознаграждение. Бывает двух типов: **"Процент"** или **"Ставка"**.
- **Транзакция клиента (`ClientTransaction`)**: Запись о финансовой операции с клиентом (например, ежемесячный платеж).
- **Настройки "Наличка" (`RetailSettings`)**: Глобальный прайс-лист для розничных клиентов.
- **Склад (`Inventory`)**: Запись об остатках (например, `chemicalStockGrams`).
- **Расход (`Expense`)**: Запись об операционных расходах. Закупка химии автоматически пополняет склад.

### Схема взаимосвязей:

```
[Сотрудник]--<*(исполняет)--[Мойка]-->(оплачивает)--[Контрагент]--<*(имеет)--[Транзакция клиента]
     |              |                      |
(имеет)     (имеет комментарии)      (оплачивает)
     |              |                      |
[Схема Зарплаты]    |                  [Агрегатор]
     |              |
(связана с)         |
     |              |
[Склад] <--(пополняется)--[Расход]
```

## 2. Логика Рабочей Станции (Создание Мойки)

1.  **Выбор команды**: Менеджер или сотрудник выбирает одного или нескольких исполнителей (`Employee`).
2.  **Ввод номера машины**: После ввода госномера система ищет этот номер в истории моек.
3.  **"Память автомобиля"**:
    *   Если машина уже мылась ранее, система находит **последнюю мойку** для этого номера.
    *   **Подсказка по услугам**: Услуги из предыдущего заказа подсвечиваются и поднимаются в верх списка для быстрого повтора.
    *   **Подсказка по комментариям**: Если к прошлой мойке был оставлен комментарий, под полем ввода номера появляется **сворачиваемый блок-предупреждение** ("Есть комментарии от предыдущей смены"). Сотрудник может его раскрыть и прочитать важную информацию.
4.  **Автоматическое определение клиента**:
    *   Система ищет номер в базе **Контрагентов**. Если находит, тип клиента автоматически определяется как `counterAgentContract`.
    *   Если не найден, ищется в базах **Агрегаторов** и выводится подсказка.
5.  **Выбор услуг**: Менеджер может выбрать любую услугу из прайс-листа или добавить **произвольную услугу**.
6.  **Добавление комментария**: На шаге подтверждения есть поле для ввода **нового комментария**, который будет привязан к создаваемой мойке.
7.  **Создание записи (`WashEvent`)**: Система фиксирует всю информацию, включая баланс клиента и расход химии.

## 3. Логика Расчета Зарплаты

Это ядро финансовой системы. Расчет происходит справедливо, даже если в одной мойке участвуют сотрудники с разными схемами.

### Принцип №1: Разделение Труда

Если над одной мойкой работало **N** сотрудников, то любое вознаграждение (будь то доля от выручки или фиксированная ставка) **делится на N**.

---

### Схема "Процент от Выручки"

Сотрудник получает процент от чистой выручки, приходящейся на его долю.

**Формула:**

`ЗарплатаСотрудника = ((СуммаМойки - КомиссияЭквайринга - ОбщийВычет) / N) * (ПроцентСотрудника / 100)`

-   **КомиссияЭквайринга**: Рассчитывается только для оплат картой.
-   **ОбщийВычет**: `SalaryScheme.fixedDeduction`. Вычитается из общей суммы до расчета процентов.

---

### Схема "Фиксированная Ставка"

Сотрудник получает долю от заранее определенной ставки за каждую конкретную услугу.

**Важно**: Схема может быть привязана к конкретному источнику (например, "Ставка для ДС (Летний)") или быть **универсальной** (не привязана к источнику и применяется к любой мойке, где есть услуга с таким названием).

**Формула:**

1.  Рассчитывается **Общая Ставка за Мойку**:
    `ОбщаяСтавка = СУММА(СтавкаЗаУслугу_i - ВычетЗаУслугу_i)`
    ...для всех услуг `i`, оказанных в рамках мойки и прописанных в схеме.

2.  Рассчитывается зарплата сотрудника:
    `ЗарплатаСотрудника = ОбщаяСтавка / N`

---

## 4. Учет химии и Склад

Это замкнутая система для контроля над расходными материалами.

1.  **Приход на склад**:
    *   Менеджер создает **Расход** (`Expense`) с категорией "Закупка химии" и указывает массу в килограммах.
    *   Система автоматически пополняет `chemicalStockGrams` в файле `data/inventory.json`.

2.  **Выдача сотруднику**:
    *   На финансовой странице сотрудника менеджер нажимает "Выдать канистру".
    *   Система создает **Транзакцию сотрудника** (`EmployeeTransaction`) с типом `purchase` (покупка/долг).
    *   Одновременно со склада (`inventory.json`) **списывается** вес канистры (например, 20 000 грамм).
    *   На странице **"Склад"** ведется учет, сколько всего химии числится за каждым сотрудником.

3.  **Расход на мойку**:
    *   В **"Журнале моек"** менеджер открывает специальное окно (иконка "капля") и вносит **фактический расход в граммах для каждого сотрудника**, участвовавшего в мойке.
    *   Этот расход **не влияет** на остаток на складе, так как предполагается, что он списывается из химии, ранее выданной сотруднику. Он используется для аналитики.

4.  **Аналитика на странице "Склад"**:
    *   Отображается **текущий остаток** на основном складе.
    *   Ведется **журнал движения**: все закупки, выдачи сотрудникам и списания на мойки видны в одной ленте.
    *   Показывается **сводка по остаткам у сотрудников**.

Эта система позволяет отследить весь путь химии: от закупки до выдачи конкретному человеку и последующего расхода на конкретную машину.

---

## 5. Система внутренних комментариев (Досье на водителя)

**Цель:** Создать эффективный канал связи между сменами для обмена важной информацией о клиентах и автомобилях. Это позволяет накапливать базу знаний, повышать качество сервиса и действовать как единая команда.

**Ключевые участники:**

1.  **Сотрудник (Мойщик/Оператор):**
    *   **Что делает:** Может добавлять комментарии к любой мойке, на которой он работал, и просматривать всю историю сообщений, оставленную его коллегами.
    *   **Пример:** *«Водитель очень придирчив к дискам, просит протирать их отдельной тряпкой»* или *«Датчик парктроника слева барахлит, лить воду с осторожностью».*

2.  **Менеджер (Администратор):**
    *   **Что делает:** Имеет полный контроль. Может просматривать, **редактировать и удалять** любые комментарии для поддержания порядка и актуальности информации.

### Как это работает:

1.  **Структура данных:**
    *   Каждая мойка (`WashEvent`) содержит массив `driverComments`.
    *   Каждый комментарий — это объект `{ text: string, authorId: string, date: string }`.

2.  **Добавление/просмотр комментария (Сотрудник и Менеджер):**
    *   **Где:** На своей финансовой странице (`/employee/finance`) или в общем "Журнале моек" (`/wash-log`).
    *   **Как:** Рядом с каждой мойкой, у которой есть комментарии, отображается иконка `MessageSquare`.
    *   При нажатии открывается **диалоговое окно в виде чата**, где видна вся переписка. Любой сотрудник может добавить новое сообщение.

3.  **Модерация (Менеджер):**
    *   **Как:** В том же диалоговом окне менеджер видит иконки "Редактировать" и "Удалить" рядом с каждым сообщением, что позволяет ему исправлять опечатки или удалять неактуальную информацию.

4.  **Использование информации на Рабочей станции:**
    *   **Как:** Когда сотрудник вводит номер машины, система проверяет **последнюю мойку** этого автомобиля.
    *   Если к ней были оставлены комментарии, на экране появляется **сворачиваемый блок-предупреждение**.
    *   **По умолчанию блок свернут**, чтобы не мешать. Сотрудник, видя предупреждение, может его раскрыть.
    *   Внутри отображается **последний комментарий**, имя его автора и дата. Это позволяет быстро передать самую актуальную информацию следующей смене.
